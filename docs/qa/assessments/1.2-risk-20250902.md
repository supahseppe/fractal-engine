# Risk Profile: Story 1.2 — Implement Step 4: Character Profiles

Date: 2025-09-02
Reviewer: Quinn (Test Architect)
Story: 1.2
Story Title: Implement Step 4: Character Profiles - Brownfield Addition
Source Story: [docs/stories/story-1.2-character-profiles.md](docs/stories/story-1.2-character-profiles.md)

## Executive Summary

- Total Risks Identified: 10
- Critical Risks (score 9): 0
- High Risks (score 6): 1
- Medium Risks (score 4): 5
- Low Risks (score 2–3): 4
- Overall Story Risk Score: 57/100

Rationale:
- No critical risks identified.
- One high security risk (XSS from AI-generated content if rendered unsafely).
- Most remaining risks are medium and manageable with standard controls (Dexie migration, store load ordering, performance for large text, accessibility).
- Lows include storage quota and rollback ergonomics.

## Gate YAML Block (paste into gate file under risk_summary)

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 5
    low: 4
  highest:
    id: SEC-001
    score: 6
    title: "XSS via AI-generated content rendered as HTML in profile view"
  recommendations:
    must_fix:
      - "Sanitize/escape all profile render paths; strip HTML from AI responses; enforce text-only bindings; add CSP"
    monitor:
      - "Observe IndexedDB storage usage/quota; monitor save error rates; watch input latency for very long profiles"
```

Hook line for review tasks:
Risk profile: docs/qa/assessments/1.2-risk-20250902.md

## Risk Matrix

| Risk ID  | Description                                                        | Probability | Impact | Score | Priority |
|---------:|--------------------------------------------------------------------|-------------|--------|-------|----------|
| SEC-001  | XSS via AI-generated content rendered as HTML in profile view      | Medium (2)  | High (3) | 6   | High     |
| TECH-001 | Dexie migration for new profiles table could malfunction           | Medium (2)  | Medium (2) | 4 | Medium   |
| TECH-002 | Store load-order/race between characters and profiles              | Medium (2)  | Medium (2) | 4 | Medium   |
| PERF-001 | Large profile text degrades typing/render performance              | Medium (2)  | Medium (2) | 4 | Medium   |
| SEC-002  | Prompt injection influences content quality or unsafe tokens       | Medium (2)  | Medium (2) | 4 | Medium   |
| TECH-003 | Accessibility regressions in new profile editor                    | Medium (2)  | Medium (2) | 4 | Medium   |
| DATA-001 | Save failures cause data loss/corruption without transaction guard | Low (1)     | High (3) | 3   | Low      |
| DATA-002 | IndexedDB quota exceeded with long profiles                        | Low (1)     | Medium (2) | 2 | Low      |
| OPS-001  | No ergonomic rollback of migration/UI entry points                 | Low (1)     | Medium (2) | 2 | Low      |
| BUS-001  | Profiles UX doesn’t meet user needs (low perceived value)          | Low (1)     | Medium (2) | 2 | Low      |

## Detailed Risk Register and Mitigations

### SEC-001: XSS via AI-generated content rendered as HTML in profile view
- Category: Security
- Description: If AI content includes HTML/script, rendering with unsafe HTML could execute code.
- Probability: Medium (2)
- Impact: High (3)
- Score: 6 (High)
- Strategy: preventive
- Actions:
  - Enforce text-only rendering for profile content in Lit (use text bindings, avoid unsafeHTML).
  - Sanitize/strip HTML from AI responses before persistence.
  - Consider CSP headers in dev server/prod proxy to block inline script.
  - Add unit tests to assert that angle brackets are escaped at render.
- Testing Requirements:
  - Inject payloads like `<img src=x onerror=alert(1)>` into AI response and assert DOM text output, not HTML execution.
  - Verify no usage of unsafe HTML paths in [js/ui/character-view.js](js/ui/character-view.js) and the planned profile component.
- Residual Risk: Low
- Owner: dev
- Timeline: Before release of Step 4

### TECH-001: Dexie migration for new profiles table could malfunction
- Category: Technical
- Description: New table/version bump may mis-handle upgrades or backfill.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Strategy: preventive
- Actions:
  - Use additive-only migration with version gating and upgrade hooks in [js/db.js](js/db.js).
  - Write migration unit test with Dexie in-memory/mocked to validate upgrade path.
  - Guard reads with null/undefined checks to avoid runtime.
- Testing Requirements:
  - Migration test simulating existing data → post-upgrade schema contains both character and profile records intact.
- Residual Risk: Low
- Owner: dev
- Timeline: During implementation

### TECH-002: Store load-order/race between characters and profiles
- Category: Technical
- Description: Profiles depend on character selection; load order and status flags must be race-safe.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Strategy: preventive/detective
- Actions:
  - Idempotent loaders with isLoaded flags in [js/store.js](js/store.js).
  - Derive selectors that tolerate empty intermediate state.
  - Component `connectedCallback` must check store presence and subscribe safely (learning from Step 3 fixes).
- Testing Requirements:
  - Unit tests for loaders and a JSDOM render test to ensure no undefined errors when profile view mounts pre-load.
- Residual Risk: Low
- Owner: dev
- Timeline: During implementation

### PERF-001: Large profile text degrades typing/render performance
- Category: Performance
- Description: Long text in a large textarea could affect responsiveness and autosave.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Strategy: preventive
- Actions:
  - Throttle/debounce input-bound saves (e.g., 300–500 ms).
  - Consider soft length guidance and character counter.
  - Avoid heavy synchronous transforms on input.
- Testing Requirements:
  - Manual check with ~5–10k characters; ensure no obvious jank; verify debounce works.
- Residual Risk: Low
- Owner: dev
- Timeline: During implementation

### SEC-002: Prompt injection influences content or unsafe token usage
- Category: Security
- Description: AI prompts could be manipulated to include instructions or sensitive echoes.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Strategy: preventive/monitor
- Actions:
  - Constrain prompt to generate text only; post-validate structure/content.
  - Clamp/strip unexpected fields before persistence.
- Testing Requirements:
  - Unit tests for response validator to drop extraneous fields/HTML.
- Residual Risk: Low
- Owner: dev
- Timeline: During implementation

### TECH-003: Accessibility regressions in new profile editor
- Category: Technical
- Description: Missing labels/focus management could degrade a11y vs Step 3 standards.
- Probability: Medium (2)
- Impact: Medium (2)
- Score: 4 (Medium)
- Strategy: preventive
- Actions:
  - Mirror Step 3 patterns: labeled controls, focus restoration, aria-describedby for validation.
  - Add keyboard behavior parity (Enter/Escape conventions).
- Testing Requirements:
  - Manual keyboard and screen-reader pass; unit checks for presence of aria attributes.
- Residual Risk: Low
- Owner: dev
- Timeline: During implementation

### DATA-001: Save failures cause data loss/corruption without transaction guard
- Category: Data
- Description: Partial writes may leave inconsistent state.
- Probability: Low (1)
- Impact: High (3)
- Score: 3 (Low)
- Strategy: preventive/corrective
- Actions:
  - Use Dexie transactions for multi-step saves.
  - Surface errors with non-blocking UI, enable retry.
- Testing Requirements:
  - Simulate storage failure and assert rollback + user feedback.
- Residual Risk: Low
- Owner: dev
- Timeline: During implementation

### DATA-002: IndexedDB quota exceeded with long profiles
- Category: Data
- Description: Very long profiles may pressure quota.
- Probability: Low (1)
- Impact: Medium (2)
- Score: 2 (Low)
- Strategy: monitor/preventive
- Actions:
  - Provide soft guidance/counter; consider max profile length cap.
  - Monitor estimated storage usage during dev.
- Testing Requirements:
  - Manual test with large inputs; verify save errors are handled gracefully.
- Residual Risk: Low
- Owner: dev
- Timeline: Post-implementation monitoring

### OPS-001: No ergonomic rollback of migration/UI entry points
- Category: Operational
- Description: Hard to disable feature quickly if issues arise.
- Probability: Low (1)
- Impact: Medium (2)
- Score: 2 (Low)
- Strategy: corrective
- Actions:
  - Gate sidebar/profile route behind a feature flag similar to Step 3 guard.
  - Keep schema additive; disabling UI should not risk data.
- Testing Requirements:
  - Toggle test to ensure UI can be disabled without errors.
- Residual Risk: Low
- Owner: dev
- Timeline: Before release

### BUS-001: Profiles UX doesn’t meet user needs
- Category: Business
- Description: Feature may not provide sufficient value/clarity.
- Probability: Low (1)
- Impact: Medium (2)
- Score: 2 (Low)
- Strategy: monitor
- Actions:
  - Align with existing Step 3 patterns and copy; keep flows minimal.
  - Collect anecdotal feedback during QA passes.
- Testing Requirements:
  - Heuristic UX review; verify consistency with Step 3.
- Residual Risk: Low
- Owner: PO/UX
- Timeline: Post-implementation

## Risk Distribution

### By Category
- Security: 2 (High: 1)
- Performance: 1 (High: 0)
- Data: 2 (High: 0)
- Business: 1 (High: 0)
- Operational: 1 (High: 0)
- Technical: 3 (High: 0)

### By Component
- Frontend (Lit components): Most risks (rendering, a11y, performance)
- Database (Dexie): Migration, transactionality, quota
- Backend/Infrastructure: N/A for this story scope

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Security/XSS:
  - Unit: Rendering escapes AI-injected HTML in profile component.
  - Integration: AI response validator drops/escapes tags before persistence.
  - Manual: Attempt common XSS payloads; verify plain text only.

### Priority 2: Medium Risk Tests
- Migration:
  - Dexie upgrade test from pre-1.2 DB → new profiles table; existing data intact.
- Store race/order:
  - JSDOM test mounting profile view before loaders; no undefined access; subscriptions safe.
- Performance:
  - Manual typing latency check with very long text; debounce verification.
- Accessibility:
  - Keyboard and aria attributes parity with Step 3.

### Priority 3: Low Risk Tests
- Data loss/rollback:
  - Simulate save failure; transaction rollback and user message verified.
- Quota:
  - Manual stress test; ensure graceful error surfaces.

## Monitoring Requirements
- Track IndexedDB save error rate during dev/testing.
- Observe app responsiveness when editing long profiles.
- Scan logs/console for subscription/getState access errors (regressions similar to Step 3 initial issues) via [console_errors.txt](console_errors.txt).

## Deterministic Gate Mapping
- Any score ≥ 9 → FAIL (none found)
- Else if any score ≥ 6 → CONCERNS (applies due to SEC-001 until mitigations and tests are in)
- Else → PASS

## References
- Story: [docs/stories/story-1.2-character-profiles.md](docs/stories/story-1.2-character-profiles.md)
- Step 3 prior art: [docs/stories/story-1.1-character-summaries.md](docs/stories/story-1.1-character-summaries.md)
- UI components (existing patterns):
  - [js/ui/character-view.js](js/ui/character-view.js)
  - [js/ui/project-sidebar.js](js/ui/project-sidebar.js)
  - [js/ui/ai-modal.js](js/ui/ai-modal.js)
- State/DB:
  - [js/store.js](js/store.js)
  - [js/db.js](js/db.js)
- QA Plan: [docs/prd/7-qa-plan.md](docs/prd/7-qa-plan.md)