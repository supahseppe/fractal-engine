# Test Design: Story 1.2 — Implement Step 4: Character Profiles

Date: 2025-09-02
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 2 (13%)
- Integration tests: 7 (47%)
- E2E tests: 6 (40%)
- Priority distribution: P0: 4, P1: 7, P2: 3, P3: 1

Notes:
- Prioritize security and data integrity (SEC-001, DATA-*) and migration (TECH-001).
- Keep E2E focused on critical journeys (navigation, AI expand, regression of Steps 1–3).
- Prefer unit/integration for render escaping and validator logic to shift left on security.

## Test Scenarios by Acceptance Criteria

### AC1: Clicking on a character opens a detailed profile view

| ID             | Level       | Priority | Test                                                                 | Justification                                           |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------------------------------------------------- |
| 1.2-INT-003    | Integration | P1       | From character list, clicking item mounts Profile view for that id   | Component-store-router interaction (view mount & props) |
| 1.2-E2E-002    | E2E         | P1       | User clicks character; profile view opens showing correct character  | Critical user journey                                   |

### AC2: Profile view contains a large text area for the character's profile

| ID             | Level       | Priority | Test                                                                                 | Justification                                |
| -------------- | ----------- | -------- | ------------------------------------------------------------------------------------ | -------------------------------------------- |
| 1.2-UNIT-002   | Unit        | P1       | Component renders labeled textarea with appropriate aria and character-count affordance | Pure render/a11y concerns                    |
| 1.2-INT-004    | Integration | P1       | Typing updates state with 300–500 ms debounce; no jank with moderate input           | Store binding and throttled persistence      |
| 1.2-E2E-006    | E2E         | P2       | Manual long-text (10k chars) typing remains usable; UI stays responsive               | Performance observation in realistic context |

### AC3: AI assistant expands a character's summary into a full profile

| ID             | Level       | Priority | Test                                                                                       | Justification                                      |
| -------------- | ----------- | -------- | ------------------------------------------------------------------------------------------ | -------------------------------------------------- |
| 1.2-UNIT-001   | Unit        | P0       | AI response validator strips HTML/tags and enforces text-only content                      | Security shift-left (SEC-001, SEC-002)             |
| 1.2-INT-001    | Integration | P0       | Rendering path escapes angle brackets; injected HTML is not interpreted in profile editor  | Prevent XSS at render boundary (SEC-001)           |
| 1.2-E2E-001    | E2E         | P0       | Manual XSS payload in AI result shows literally and does not execute                       | High-risk manual verification (SEC-001)            |
| 1.2-E2E-004    | E2E         | P1       | Trigger AI assistant; modal shows loading; result populates textarea as plain text         | End-to-end generation and UI update                 |

### AC4: All profile data is saved to Dexie and linked to the correct character

| ID             | Level       | Priority | Test                                                                                          | Justification                                     |
| -------------- | ----------- | -------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| 1.2-INT-002    | Integration | P0       | Save profile then reload app; profile text persists and is associated to the correct character | Data integrity is critical                        |
| 1.2-INT-005    | Integration | P1       | Dexie migration adds profiles table; existing character data remains intact                    | Migration correctness (TECH-001)                  |
| 1.2-INT-007    | Integration | P2       | Simulated save failure rolls back transaction and surfaces non-blocking error notification     | Graceful failure (DATA-001)                       |
| 1.2-E2E-005    | E2E         | P2       | Quota exceeded scenario surfaces friendly error; app remains usable                            | User-facing handling (DATA-002)                   |

### AC5–AC7: Regression and pattern adherence

| ID             | Level       | Priority | Test                                                                                   | Justification                                   |
| -------------- | ----------- | -------- | -------------------------------------------------------------------------------------- | ----------------------------------------------- |
| 1.2-INT-006    | Integration | P1       | Mount profile view before store/DB load; no undefined access; subscribes safely        | Race-safety per store patterns (TECH-002)       |
| 1.2-E2E-003    | E2E         | P1       | Regression smoke: Steps 1–3 loads, edit, and save still work                           | Ensure no regressions in existing flows         |
| 1.2-E2E-007    | E2E         | P2       | Feature flag off hides profile entry; app loads and Steps 1–3 operate                   | Operational rollback (OPS-001)                  |
| 1.2-E2E-008    | E2E         | P3       | Heuristic UX review: Profile editor consistent with Step 3 controls and copy            | Business value/consistency (BUS-001)            |

## Risk Coverage

- SEC-001 (XSS via AI-generated content): 1.2-UNIT-001, 1.2-INT-001, 1.2-E2E-001
- TECH-001 (Dexie migration): 1.2-INT-005
- TECH-002 (Store load-order/race): 1.2-INT-006
- PERF-001 (Large text performance): 1.2-INT-004, 1.2-E2E-006
- SEC-002 (Prompt injection/unsafe tokens): 1.2-UNIT-001
- TECH-003 (Accessibility regressions): 1.2-UNIT-002
- DATA-001 (Save failure/rollback): 1.2-INT-007
- DATA-002 (Quota exceeded): 1.2-E2E-005
- OPS-001 (Rollback ergonomics): 1.2-E2E-007
- BUS-001 (UX/value fit): 1.2-E2E-008

All identified risks have at least one corresponding scenario.

## Recommended Execution Order

1. P0 Unit tests (1.2-UNIT-001)
2. P0 Integration tests (1.2-INT-001, 1.2-INT-002)
3. P0 E2E tests (1.2-E2E-001)
4. P1 Integration tests (1.2-INT-003, 1.2-INT-004, 1.2-INT-005, 1.2-INT-006)
5. P1 E2E tests (1.2-E2E-002, 1.2-E2E-004)
6. P2 tests (1.2-INT-007, 1.2-E2E-005, 1.2-E2E-007)
7. P3 test (1.2-E2E-008)

## Implementation Hints (non-binding)

- 1.2-UNIT-001: Export a small `validateProfileResponse(text)` from `js/api.js` or a helper; assert it removes/escapes tags and clamps length.
- 1.2-INT-001: Assert Lit bindings use text nodes for profile content; avoid `unsafeHTML` for editor content.
- 1.2-INT-004: Inject a debounced `input` handler; test with fake timers to assert a single save after burst.
- 1.2-INT-005: Bump Dexie `db.version(...)` with additive store; use Dexie in-memory for migration test.
- 1.2-INT-006: Mount with store undefined, then provide; expect no throws and correct re-render.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 2
    integration: 7
    e2e: 6
  by_priority:
    p0: 4
    p1: 7
    p2: 3
    p3: 1
  coverage_gaps: []
```

## Trace References

Test design matrix: qa.qaLocation/assessments/1.2-test-design-20250902.md
P0 tests identified: 4

## Sources

- Risk profile: docs/qa/assessments/1.2-risk-20250902.md
- Story: docs/stories/story-1.2-character-profiles.md
- Prior art/components: js/ui/character-view.js, js/ui/project-sidebar.js, js/ui/ai-modal.js, js/store.js, js/db.js

